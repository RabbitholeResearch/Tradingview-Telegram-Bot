from selenium import webdriver
from selenium.webdriver import ActionChains, Keys
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
import os
import time
from threading import Thread
import telegrambot

def setup():
    chrome_options = Options()
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.add_argument('--headless')
    chrome_options.add_argument('--disable-gpu')
    chrome_options.add_argument("--window-size=1920,1080")
    capabilities = {
    "resolution": "1920X1080"
    }
    driver = webdriver.Chrome(options=chrome_options, desired_capabilities=capabilities)
    return driver

def login(driver, username, password):
    driver.get('https://www.tradingview.com/#signin')
    driver.find_element(By.NAME, "username").send_keys(username)
    driver.find_element(By.NAME, "password").send_keys(password)
    driver.find_element(By.XPATH, "//button[@type='submit']").click()
    time.sleep(5)

def screenshot(driver, chart):
    driver.get("https://www.tradingview.com/chart/"+chart+"/")
    time.sleep(5)
    driver.save_screenshot("screenshot.png")
    return "screenshot.png"

def quit_browser(driver):
    driver.close()
    driver.quit()

def send_chart(chart, loginNeeded):
    driver = setup()
    if loginNeeded:
        username = os.environ['Apollo534']
        password = os.environ['19!Daniel83']
        login(driver, username, password)
screenshot_path = screenshot(driver, chart)
telegrambot.sendPhoto(screenshot_path)
quit_browser(driver)

def send_chart_async(chart, loginRequired=True):
try:
capture = Thread(target=send_chart, args=[chart, loginRequired])
capture.start()
except Exception as e:
print("[X] Capture error:\n>", e)

